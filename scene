#!/bin/bash
set -e
action="$1"

entry="$(date-ft)_$(_rand 1000)"
log (){ echo "$0 $(date-ft) entry[$entry]: $@" >> ~/.temp/scene.txt ;}

daytime_file="$(realpath ~/_/localhost/http-server/daytime.txt)"
daytime_pipe="$(realpath ~/.temp/daytime)"
[ -p "$daytime_pipe" ] || mkfifo "$daytime_pipe"

calc_ranges() {
    if [ "$ranges_calculated_on" = "$(date-ft)" ]; then
        return
    else
        ranges_calculated_on="$(date-ft)"
    fi

    astro="$(hdate                                             \
        --sun                                                  \
        --latitude  N$(location latitude)                      \
        --longitude E$(location longitude)                     \
        --timezone  $(date +%z |sed -r 's/^\+0([0-9])00$/\1/') \
        2>/dev/null)"
    when () { echo "$astro" |grep "$1" |sed -r "s/^.*$1: ([0-9]{2}:[0-9]{2}).*$/\1/" ;}
    _date() { date -d "$1" +%s ;}

    sunrise=$(_date $(when sunrise))
    sunset=$(_date $(when sunset))

    day=$sunrise
    twilight=$(( $sunset - 45*60 ))
    evening=$(( $sunset + 15*60 ))
    night=$(_date "22:00")
    darkness=$(_date "23:00")
    midnight=$(_date "tomorrow 00:00")
}

daytimes="day twilight evening night darkness midnight"

function brightness_for {
    local daytime="$1"
    case "$daytime" in
        day)      printf 100 ;;
        twilight) printf 100 ;;
        evening)  printf  75 ;;
        night)    printf  50 ;;
        darkness) printf  25 ;;
        midnight) printf   5 ;;
    esac
}

function first { printf "$daytimes" |sed -r 's/^([^ ]+) .*$/\1/' ;}
function last { printf "$daytimes" |sed -r 's/^.* ([^ ]+)$/\1/' ;}
function next_after {
    local daytime="$1"
    if [ "$daytime" = "$(last)" ]; then
        printf "$(first)"
    else
        printf "$daytimes" |sed -r "s/^.*$daytime ([^ ]+).*$/\1/"
    fi
}

function nominal {
    calc_ranges
    local now=$(date +%s)
    local prev="$(last)"
    for daytime in $daytimes; do
        if [ $now -lt "${!daytime}" ]; then  # bash
            printf "$prev"
            return
        else
            prev="$daytime"
        fi
    done
}

bgs_file="$HOME/.temp/backgrounds.txt"
function save_bg {
    local daytime="$1"
    touch "$bgs_file"
    sed -i "/^$daytime:.*\$/d" "$bgs_file"
    echo "$daytime: $(get-background)" >> "$bgs_file"
}

log "@: $@"

if [[ " $daytimes " =~ " $action " ]]; then
    echo "$action" > "$daytime_pipe"
    exit 0
fi

case "$action" in
    movie)
        while ! _external-display-connected; do sleep 1; done
        prev="$($0 actual)"
        if [ "$2" ]; then
            light desk "$2"
        else
            light desk off
        fi
        light corridor off
        sleep 2
        brightness set scene 50
        while _external-display-connected; do sleep 1; done
        $0 "$(nominal)"
        ;;
    next) $0 "$(next_after "$($0 actual)")" ;;
    actual) cat "$daytime_file" ;;
    when)
        calc_ranges
        current="$($0 actual)"
        format="+%H:%M"
        for daytime in $daytimes; do
            echo "$daytime: $(date -d @${!daytime} $format)"  # bash
            if [ "$daytime" = "$current" ]; then
                echo "  now: $(date $format)"
            fi
        done
        echo ""
        echo "sunset: $(date -d @$sunset $format)"
        ;;
    nominal) echo "$(nominal)" ;;
    schedule)
        prev=""
        while :; do
            if _external-display-connected; then
                sleep 10
                continue
            fi

            daytime="$(nominal)"

            if [ "$daytime" != "$prev" ]; then
                prev="$daytime"
                echo "$daytime" > "$daytime_pipe"
            fi

            sleep 1
        done
        ;;
#    server)
#        dir="$(dirname "$daytime_file")"
#
#        # pkill http-server  # kills innocents
#        # pkill "$dir"  # kills itself
#        _fkill -q "$dir"
#
#        port=9473
#        fuser -k $port/tcp ||:
#        eval "http-server $(echo "$dir" |sed -r 's| |\\ |g') -a 127.0.0.1 -p $port --cors='Access-Control-Allow-Origin: *'"
#        # http-server "$(echo "$dir" |sed -r 's| |\\ |g')" -a 127.0.0.1 -p $port --cors='Access-Control-Allow-Origin: *'
#        # http-server $(echo "$dir" |sed -r 's| |\\ |g') -a 127.0.0.1 -p $port --cors='Access-Control-Allow-Origin: *'
#        ;;
    light)
        daytime="$2"
        calc_ranges

        if [ "$daytime" = "$(last)" ] || [ "$daytime" != "$(nominal)" ]; then
            brightness transition  # kill a running one
            brightness set scene "$(brightness_for "$daytime")"
        else
            next="$(next_after "$daytime")"
            run-detached "brightness transition $(brightness_for $daytime) ${!daytime} $(brightness_for $next) ${!next}"
        fi

        if at-home; then
            to=""
            if [ "$daytime" = "$(nominal)" ]; then
                if [[ " twilight evening darkness " =~ " $daytime " ]]; then  # bash
                    to="$(next_after $daytime)"
                fi
            fi
            if [ "$to" ]; then
                run-detached "light transition $daytime ${!daytime} $to ${!to}"  # bash
            else
                light "$daytime"
            fi
        fi
        ;;
    listen_pipe)
        prev="$($0 actual)"
        tail -f "$daytime_pipe" |while read daytime; do
            # MAYBE: parallel

            echo "$daytime" > "$daytime_file"

            # backgrounds
            save_bg "$prev"
            bg="$(cat "$bgs_file" |grep -E "^$daytime:" |sed -r "s/^$daytime: (.*)$/\1/")"
            if [ "$bg" ]; then
                set-background "$bg"
            fi

            # themes
            if [ "$daytime" = "day" ]; then
                new_theme="'Adapta'"
            else
                new_theme="'Adapta-Nokto'"
            fi
            conf_key="/org/cinnamon/desktop/interface/gtk-theme"
            cur_theme="$(dconf read "$conf_key")"
            if [ "$cur_theme" != "$new_theme" ]; then
                dconf write "$conf_key" "$new_theme"
            fi

            $0 light "$daytime"

            prev="$daytime"
        done
        ;;
    all)
        save_bg "$($0 actual)"
        parallel -n "
            $0 schedule
            $0 listen_pipe
        "
        ;;
    help) echo "Options: $daytimes movie next actual when nominal" ;;
    *) echo "Options: $daytimes movie next actual when nominal schedule light listen_pipe all" >&2 ;;
esac

#!/bin/bash
set -e
action="$1"

log (){ echo "$0 $(date-ft) $@" >> ~/.temp/scene.txt ;}

daytime_file="$(realpath ~/_/localhost/http-server/daytime.txt)"
daytime_pipe="$(realpath ~/.temp/daytime)"
calc_ranges() {
    if [ "$ranges_calculated_on" = "$(date-ft)" ]; then
        return
    else
        ranges_calculated_on="$(date-ft)"
    fi

    astro="$(hdate -s -l N$(location latitude) -L E$(location longitude) -z2 2>/dev/null)"
    when () { echo "$astro" |grep "$1" |sed -r "s/^.*$1: ([0-9]{2}:[0-9]{2}).*$/\1/" ;}

    sunrise=$(date -d $(when sunrise) +%s)
    sunset=$(date -d $(when sunset) +%s)

    day=$sunrise
    twilight=$(( $sunset - 45*60 ))
    evening=$(( $sunset + 15*60 ))
    night=$(( $evening + 60*60 ))
}

function nominal {
    calc_ranges
    local now=$(date +%s)
    function between {
        if [ $1 -le $now ] && [ $now -lt $2 ]; then
            return 0
        else
            return 1
        fi
    }
    if between $day $twilight ; then
        printf "day"
    elif between $twilight $evening ; then
        printf "twilight"
    elif between $evening $night ; then
        printf "evening"
    else
        printf "night"
    fi
}

bgs_file="$HOME/.temp/backgrounds.txt"
function save_bg {
    local daytime="$1"
    touch "$bgs_file"
    sed -i "/^$daytime:.*\$/d" "$bgs_file"
    echo "$daytime: $(get-background)" >> "$bgs_file"
}

log "@: $@"

case "$action" in
    day|twilight|evening|night)
log "manual: $action"
        echo "$action" > "$daytime_pipe"
        ;;
    movie)
        prev="$($0 actual)"
        if [ "$2" ]; then
            bulb "$2"
        fi
        while ! _external-display-connected; do sleep 1; done
        sleep 2
        brightness 0.5
        while _external-display-connected; do sleep 1; done
        if [ "$(nominal)" = "$prev" ]; then
            $0 light "$prev"
        fi
        ;;
    next)
        case "$($0 actual)" in
            day)      $0 twilight ;;
            twilight) $0 evening  ;;
            evening)  $0 night    ;;
            night)    $0 day      ;;
        esac
        ;;
    actual) cat "$daytime_file" ;;
    when)
        calc_ranges
        for daytime in day twilight evening night sunset; do
            echo "$daytime: $(date -d @${!daytime} +%H:%M)"
        done
        ;;
    nominal) echo "$(nominal)" ;;
    schedule)
        prev=""
        while :; do
            if _external-display-connected; then
                sleep 10
                continue
            fi

            daytime="$(nominal)"

            if [ "$daytime" != "$prev" ]; then
log "prev $prev, nominal $daytime"
                prev="$daytime"
                echo "$daytime" > "$daytime_pipe"
            fi

            sleep 1
        done
        ;;
    server)
        dir="$(dirname "$daytime_file")"

        # pkill http-server  # kills innocents
        # pkill "$dir"  # kills itself
        _fkill -q "$dir"

        eval "http-server $(echo "$dir" |sed -r 's| |\\ |g') -a 127.0.0.1 -p 9473 --cors='Access-Control-Allow-Origin: *'"
        # http-server "$(echo "$dir" |sed -r 's| |\\ |g')" -a 127.0.0.1 -p 9473 --cors='Access-Control-Allow-Origin: *'
        # http-server $(echo "$dir" |sed -r 's| |\\ |g') -a 127.0.0.1 -p 9473 --cors='Access-Control-Allow-Origin: *'
        ;;
    light)
        daytime="$2"
        calc_ranges
        case "$daytime" in
            day)      brightness      100 ;;
            twilight) brightness --max 75 ;;
            evening)  brightness --max 50 ;;
            night)    brightness --max 25 ;;
        esac
        if at-home; then
            case "$daytime" in
                day)   bulb off   ;;
                night) bulb night ;;
                *)
                    if [ "$daytime" = "$(nominal)" ]; then
                        case "$daytime" in
                            twilight) run-detached "bulb transition twilight $twilight evening $evening" ;;
                            evening)  run-detached "bulb transition evening  $evening  night   $night  " ;;
                        esac
                    else
                        now=$(date +%s)
                        case "$daytime" in
                            twilight) run-detached "bulb transition twilight $now evening $evening" ;;
                            evening)  run-detached "bulb transition evening  $now night   $night  " ;;
                        esac
                    fi
                    ;;
            esac
        fi
        ;;
    listen_pipe)
        prev="$($0 actual)"
        tail -f "$daytime_pipe" |while read daytime; do
log "read from pipe: $daytime"
            $0 light "$daytime"
            echo "$daytime" > "$daytime_file"

            # backgrounds
            save_bg "$prev"
            bg="$(cat "$bgs_file" |grep -E "^$daytime:" |sed -r "s/^$daytime: (.*)$/\1/")"
            if [ "$bg" ]; then
                set-background "$bg"
            fi

            prev="$daytime"
        done
        ;;
    all)
        save_bg "$($0 actual)"
        parallel -n "
            $0 schedule
            $0 server
            $0 listen_pipe
        "
        ;;
    help) echo "Options: day twilight evening night movie next actual when nominal" ;;
    *) echo "Options: day twilight evening night movie next actual when nominal schedule server light listen_pipe all" >&2 ;;
esac
